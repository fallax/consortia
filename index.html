<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75, user-scalable=no">
    <title>Consortia</title>
    <script src="chroma.min.js"></script>
    <style>
        html {
            touch-action: none;
        }

        body {
            font-family: Helvetica, Arial, sans;
            display: flex;
            flex-direction: row;
            font-size: 24px;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;

            background-color: #868998;
        }

        #alert {
            position: fixed;
            top: 0px;
            height: 100px;
            width: 400px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            visibility: hidden;
        }

        .book {
            font-size: 16px;
            background-color: darkred;
            color: white;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .author,
        .title {
            padding: 0 12px;
            height: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .selected {
            box-shadow: 0px 0px 5px 5px rgb(255, 140, 0);
            z-index: 100;
        }

        #hand .book {
            box-shadow: 0px 0px 20px 15px rgba(0, 0, 0, 0.8)
        }

        .placeholder {
            padding-left: 12px;
            font-size: 20px;
            background: rgba(0, 0, 20, 0.4) !important;
            color: rgba(0, 0, 0, 0) !important;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .placeholder .author, .placeholder .title
        {
            color: rgba(0,0,0,0);
            background: none !important;
        }

        #shelf {
            margin-left: 24px;
            width: 400px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            border-right: 20px solid aliceblue;
        }

        #hand {
            font-size: 50px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            z-index: 100;
            height: 100px;
            width: 400px;
            position: absolute;
        }
    </style>
    <script>

        var achievements = [
            {
                "title": "Sorted by Author",
                "reward": "+10 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].author.split(" ")[1] > books[i + 1].author.split(" ")[1]) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 10);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Size",
                "reward": "+2 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].width > books[i + 1].width) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 2);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Size Descending",
                "reward": "+2 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].width < books[i + 1].width) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 2);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Thickness",
                "reward": "+5 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].height > books[i + 1].height) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 2);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Thickness Descending",
                "reward": "+5 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].height < books[i + 1].height) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 5);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Hue",
                "reward": "+10 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].hue > books[i + 1].hue) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 10);
                    newbooks.forEach((book) => { books.push(book); });
                }
            },
            {
                "title": "Sorted by Hue Descending",
                "reward": "+10 books",
                "check": () => {
                    var sorted = true;
                    for (var i = 0; i < books.length - 2; i++) {
                        if (books[i].hue < books[i + 1].hue) {
                            sorted = false;
                        }
                    }
                    return sorted;
                },
                "finished": () => {
                    var newbooks = reserve.splice(0, 10);
                    newbooks.forEach((book) => { books.push(book); });
                }
            }
        ];

        var titles = [
            "Selected Verse",
            "Collected Works",
            "Complete Poems",
            "Anthology",
            "Short Stories",
            "A Time To Die",
            "Painted Leopards",
            "The Battle of Hope",
            "In the Wake",
            "Fly in the Ointment",
            "Hardlight Firefight",
            "The Midnight Hunt",
            "No Time Like The Present",
            "Dimension Chaos",
            "Apogee Element",
            "The Dusts of Ganymede",
            "Trevor in the Lake of Bones",
            "The Shards of Nyquist",
            "Old Hearts, Old Blood",
            "The Needle in the Portrait",
            "Fifteen Dusks",
            "Tied at the Final Whistle",
            "The Case of Ophelia Frown",
            "Susan's Memory Tree",
            "The Crown between the Pillars",
            "A Pauper at the Feast",
            "Lace Valley",
            "Lie to the Letter",
            "Nigel's Horse",
            "Wild Symbols",
            "My Sister's Lover",
            "Doctor Zoster",
            "Jealous Shaun",
            "Eggenham Hall",
            "The Journey of Mu",
            "Cavendish's Venus",
            "A History of Spindlecraft",
            "The Goats of the Vallavian Mountains",
            "Nuxology: an Introduction",
            "First Steps in Untangling",
            "The 1000 Greatest Vanilla Artists",
            "The Life of Lee Delamere",
            "Modern Shotput",
            "Walking Trips in the Parish of Basting",
            "Training Your Millipede",
            "The Big Book of Triangles",
            "Butterhill Village Through The Ages",
            "Roman Settlements across Great Brittle",
            "The Encyclopedia of Cheeses",
            "A First Course in Needle Welding",
            "Introducing Para-psychography",
            "Neo-Neutronian Architecture 1945-1979",
            "A Year in Artex",
            "My Own Mother",
            "Knowing Arthur",
            "How to Draw Pelargic Birds",
            "The Machine of Grief",
            "Triangulating the Day",
            "Aria for Aries",
            "Sixes and Nines",
            "Answer on a Postcard",
            "The Unburning Flame",
            "The Crow Flies",
            "Death's Door",
            "Or For Worse",
            "Badge of Honour",
            "The Six Year's War",
            "New Approaches in Buffalo Migration Studies",
            "More Powerful Presentations",
            "Hat Skills for Young Learners",
            "A New Course in Sedimentary Rocks",
            "Both Ways Around The World",
            "Good Hair Design",
            "How To Understand Your New Microwave",
            "Mains Powered Apparatus Safety",
            "1001 Great Pasta Dishes",
            "More Melodies for Intermediate Clarinet",
            "Measuring Overhead Catenary Voltages",
            "Man and God",
            "The Riders of Gusset Valley",
            "Ceramics: an Introduction",
            "First Steps in Logistics",
            "The Practicioners Guide to Paediatric Nursing",
            "Woodworking: a field manual",
            "The 1000 Greatest Films of All Time",
            "A Year in Venice",
            "The Life of Dr Fred Clammy",
            "An Illustrated History of Basting",
            "Modern Recording Techniques",
            "Walking Trips in Portend",
            "Training Your Ferret",
            "Baking The Easy Way",
            "Upholstry Made Simple",
            "The Encyclopedia of Cheese",
            "A First Cause in Homophony",
            "Introducing Drench",
            "Dead in the Water",
            "Emergency Resuscitation for Dummies",
            "Word Puzzles for Minoan Beginners",
            "A Historianâ€™s Guide to Pork Cathedral",
            "A Topological Dictionary of Ancient Greek",
            "Telehandler Operation and Maintenance",
            "Modelling Spherical Tokamaks",
            "Person-Centred Approaches to Dissociation",
            "An Oral History of Haslet Branch Library",
            "Modern Maritime Lubricant Formulations",
            "Hydroforming Convex Galvanised Components",
            "The Design and Implementation of Distributed Algorithms",
            "Cartesian Holotropy Theory",
            "New Developments in Plate Tectonics",
            "The RT/23 Technical Manual"
        ];


        var names = {
            "manual": [
                "Richard Charnock",
                "Chaise Long",
                "Lucy Morell",
                "Lee Delamere",
                "Dean Taunton"
            ],
            "given-names": {
                "negative": [
                    "shame",
                    "gluttony",
                    "dentine",
                    "altimeter",
                    "catheter",
                    "raglan",
                    "heave",
                    "rennet",
                    "retina",
                    "withdrew",
                    "bevel",
                    "lanolin",
                    "baryon",
                    "knarl",
                    "almond",
                    "stave",
                    "favela",
                    "flan",
                    "latrine",
                    "hazard",
                    "cloret",
                    "tabbard",
                    "witherward",
                    "barren",
                    "litany",
                    "curfew",
                    "prion",
                    "haslet",
                    "histamine",
                    "tarry",
                    "curette",
                    "ceefax",
                    "araldite",
                    "emnity",
                    "annelid",
                    "cilia",
                    "myelin",
                    "fontanelle",
                    "petri",
                    "atonia",
                    "avarice",
                    "median",
                    "felony",
                    "rubella",
                    "favela",
                    "baleen",
                    "stave",
                    "felony",
                    "stevia",
                    "olestra",
                    "yob",
                    "retina",
                    "raglan",
                    "enamel",
                    "chamois",
                    "nicoise",
                    "cloaca",
                    "seethe",
                    "hernia",
                    "haslet",
                    "gannet",
                    "rant",
                    "grief",
                    "artifice",
                    "malice",
                    "callus",
                    "gelatine",
                    "violent",
                    "celery",
                    "tissue",
                    "vanilla",
                    "countenance",
                    "sinus",
                    "leotard",
                    "trivia",
                    "thermos",
                    "chance",
                    "fray",
                    "margarine",
                    "cellulose",
                    "carton",
                    "maudlin",
                    "mohair",
                    "grayish",
                    "cassette",
                    "florid",
                    "malaise",
                    "casserole",
                    "wane",
                    "prude",
                    "ulna",
                    "rhodesia",
                    "credenza",
                    "chaise",
                    "hessian",
                    "shant",
                    "sinus",
                    "grave",
                    "bonjela",
                    "absentia",
                    "chlorine",
                    "punnet",
                    "wallow",
                    "phial",
                    "ebb",
                    "folly",
                    "harlot",
                    "deter",
                    "heathen",
                    "fawn",
                    "harried",
                    "falter",
                    "hack",
                    "omen",
                    "alas",
                    "yoghurt",
                    "threnody",
                    "malady",
                    "varicella",
                    "regalia",
                    "rotiserrie",
                    "norad",
                    "turnip",
                    "pilfer",
                    "teeter",
                    "satchel",
                    "cess",
                    "codeine",
                    "pleura",
                    "brawn",
                    "drain",
                    "vendetta",
                    "alive",
                    "dirge",
                    "viscera",
                    "glycerine",
                    "janky",
                    "linseed",
                    "xanthan",
                    "lawn",
                    "sack",
                    "charcuterie",
                    "pessary",
                    "denial",
                    "dive",
                    "lozenge",
                    "innard",
                    "garotte",
                    "jute",
                    "tremor",
                    "gorge",
                    "hairy",
                    "charnel",
                    "tirade",
                    "ambulance",
                    "abandon",
                    "lettuce",
                    "fib",
                    "colic",
                    "stymie",
                    "camembert"
                ],
                "positive": [
                    "flora",
                    "arabella",
                    "henrietta",
                    "beatrix",
                    "annabelle",
                    "hugo",
                    "rupert",
                    "alastair",
                    "ambrose",
                    "percy",
                    "rollo",
                    "spencer",
                    "phillip",
                    "henry",
                    "george",
                    "elizabeth",
                    "charlotte",
                    "margot",
                    "arthur",
                    "Margaret",
                    "cecil",
                    "winston",
                    "tarquin",
                    "beatrice",
                    "josephine",
                    "virginia",
                    "dorcas",
                    "ophelia"
                ],
                "standard": [
                    "susan",
                    "derek",
                    "dudley",
                    "bob",
                    "barry",
                    "Dave",
                    "Dennis",
                    "Trevor",
                    "Sarah",
                    "Robert",
                    "john",
                    "Peter",
                    "Mary",
                    "James",
                    "Michael",
                    "stuart",
                    "shaun",
                    "adam",
                    "emma",
                    "andrea",
                    "brian",
                    "natalie",
                    "kirsty",
                    "tracey",
                    "rebecca",
                    "oliver",
                    "andrew",
                    "gary",
                    "gregory",
                    "jacqueline",
                    "emily",
                    "harriet",
                    "laura",
                    "debbie",
                    "SUSAN",
                    "JULIE",
                    "KAREN",
                    "TRACEY",
                    "JANE",
                    "HELEN",
                    "DIANE",
                    "SHARON",
                    "TRACY",
                    "ANGELA",
                    "SARAH",
                    "ALISON",
                    "CAROLINE",
                    "AMANDA",
                    "SANDRA",
                    "LINDA",
                    "CATHERINE",
                    "ELIZABETH",
                    "CAROL",
                    "JOANNE",
                    "WENDY",
                    "JANET",
                    "DAWN",
                    "CHRISTINE",
                    "NICOLA",
                    "GILLIAN",
                    "SALLY",
                    "MARIA",
                    "MICHELLE",
                    "DEBRA",
                    "PAULA",
                    "ANNE",
                    "LORRAINE",
                    "PATRICIA",
                    "MARY",
                    "DENISE",
                    "MARGARET",
                    "ANN",
                    "BEVERLEY",
                    "DONNA",
                    "ELAINE",
                    "FIONA",
                    "JENNIFER",
                    "LESLEY",
                    "LOUISE",
                    "MANDY",
                    "TINA",
                    "JAYNE",
                    "SUZANNE",
                    "ANDREA",
                    "PAULINE",
                    "LISA",
                    "CLAIRE",
                    "KIM",
                    "JULIA",
                    "TERESA",
                    "HEATHER",
                    "KATHRYN",
                    "LYNN",
                    "RUTH",
                    "YVONNE",
                    "JUDITH",
                    "MELANIE",
                    "MARIE",
                    "PAMELA",
                    "CAROLE",
                    "BARBARA",
                    "GAIL",
                    "LYNNE",
                    "CLARE",
                    "JANICE",
                    "RACHEL",
                    "JILL",
                    "KATHERINE",
                    "KATHLEEN",
                    "SHIRLEY",
                    "ANNETTE",
                    "CAROLYN",
                    "ANNA",
                    "SARA",
                    "VALERIE",
                    "CHERYL",
                    "JEANETTE",
                    "KAY",
                    "ANITA",
                    "MAXINE",
                    "FRANCES",
                    "JOANNA",
                    "THERESA",
                    "DEBBIE",
                    "LYNDA",
                    "MAUREEN",
                    "ROSEMARY",
                    "MICHELE",
                    "LAURA",
                    "REBECCA",
                    "SHEILA",
                    "STEPHANIE",
                    "DAVID",
                    "PAUL",
                    "ANDREW",
                    "MARK",
                    "JOHN",
                    "MICHAEL",
                    "STEPHEN",
                    "IAN",
                    "ROBERT",
                    "RICHARD",
                    "CHRIS",
                    "PETER",
                    "SIMON",
                    "ANTHONY",
                    "KEVIN",
                    "STEVEN",
                    "MARTIN",
                    "JAMES",
                    "PHILIP",
                    "ALAN",
                    "NEIL",
                    "NIGEL",
                    "TIMOTHY",
                    "COLIN",
                    "GRAHAM",
                    "JONATHAN",
                    "NICHOLAS",
                    "WILLIAM",
                    "ADRIAN",
                    "BRIAN",
                    "STUART",
                    "KEITH",
                    "THOMAS",
                    "PATRICK",
                    "SEAN",
                    "CARL",
                    "TREVOR",
                    "WAYNE",
                    "SHAUN",
                    "KEN",
                    "BARRY",
                    "DEREK",
                    "DEAN",
                    "RAYMOND",
                    "ANTONY",
                    "JEREMY",
                    "JOSEPH",
                    "EDWARD",
                    "LEE",
                    "TERENCE",
                    "MATTHEW",
                    "DANIEL",
                    "GEORGE",
                    "RUSSELL",
                    "CHARLES",
                    "JEFFREY",
                    "CLIVE",
                    "PHILLIP",
                    "CRAIG",
                    "ROGER",
                    "JULIAN",
                    "GEOFFREY",
                    "KARL",
                    "MALCOLM",
                    "DARREN",
                    "TONY",
                    "ADAM",
                    "ROBIN",
                    "ROY",
                    "VINCENT",
                    "MOHAMMED",
                    "GORDON",
                    "DUNCAN",
                    "LESLIE",
                    "ALEXANDER",
                    "GREGORY",
                    "GARETH",
                    "RONALD",
                    "DOUGLAS",
                    "FRANCIS",
                    "STEWART",
                    "GRAEME",
                    "GUY",
                    "TERRY",
                    "ALLAN",
                    "HOWARD",
                    "JASON",
                    "IAIN",
                    "GLENN",
                    "DENNIS",
                    "GAVIN",
                    "DOMINIC"
                ]
            },
            "family-names": {
                "other": [
                    "shindogu",
                    "barbacoa",
                    "clarinet"
                ],
                "negative": [
                    "cromwell",
                    "fawkes",
                    "chamberlain",
                    "coward",
                    "dispencer",
                    "zoster",
                    "hencewith",
                    "forthwith",
                    "burden",
                    "gore",
                    "bitumen",
                    "blackwater",
                    "dander",
                    "crouch",
                    "honeybucket",
                    "hohlraum",
                    "mayhem",
                    "flinch",
                    "husk",
                    "gland",
                    "gall",
                    "spent",
                    "buckfast",
                    "moult",
                    "frill",
                    "flake",
                    "clampdown",
                    "wiles",
                    "beeching",
                    "madden",
                    "foyer",
                    "ides",
                    "moribund",
                    "bland",
                    "seabottom",
                    "heap",
                    "clout",
                    "salad",
                    "gall",
                    "shill",
                    "agar",
                    "tarnish",
                    "whine",
                    "gross",
                    "frown",
                    "peevish",
                    "harridan",
                    "headwinds",
                    "bollard",
                    "dredge",
                    "scurry",
                    "languish",
                    "currant",
                    "torrent",
                    "bellow",
                    "arson",
                    "seams",
                    "flaw",
                    "crater",
                    "wellhard",
                    "dross",
                    "tallow",
                    "grating",
                    "lavatory",
                    "swab",
                    "melt",
                    "heritage",
                    "gritty",
                    "funnel",
                    "gulley",
                    "scalding",
                    "plummet",
                    "knotweed",
                    "frantic",
                    "null",
                    "nought",
                    "abrupt",
                    "askew",
                    "wrest",
                    "gaunt",
                    "pylon",
                    "portend",
                    "foist",
                    "scant",
                    "abscond",
                    "bridle",
                    "hinder",
                    "chilblain",
                    "lambast",
                    "pillory",
                    "laminator",
                    "tantrum",
                    "oblong",
                    "lambast"
                ],
                "positive": [
                    "windsor",
                    "beaumont",
                    "devereaux",
                    "penrose",
                    "willoughby"
                ],
                "themepark": [
                    "alton",
                    "flambard",
                    "billing",
                    "botton",
                    "brean",
                    "crealy",
                    "dingle",
                    "drayton",
                    "drummond",
                    "hollycombe",
                    "lightwater",
                    "marwell",
                    "oakwood",
                    "thorpe",
                    "twinlake",
                    "watermouth",
                    "loudoun"
                ],
                "motorway-services": [
                    "pagnell",
                    "chievely",
                    "mimms",
                    "sandbach",
                    "tebay",
                    "knutsford",
                    "rownham",
                    "hopwood"
                ],
                "frequent": [
                    "Adams",
                    "Anderson",
                    "Barker",
                    "Brown",
                    "Campbell",
                    "Clark",
                    "Clarke",
                    "Coleman",
                    "Davies",
                    "Dixon",
                    "Doherty",
                    "Edwards",
                    "Evans",
                    "Graham",
                    "Green",
                    "Griffiths",
                    "Hall",
                    "Hamilton",
                    "Hill",
                    "Hughes",
                    "Hunter",
                    "Jackson",
                    "Johnson",
                    "Johnston",
                    "Jones",
                    "Kelly",
                    "Lewis",
                    "MacDonald",
                    "Martin",
                    "McLaughlin",
                    "Mitchell",
                    "Moore",
                    "Morgan",
                    "Morris",
                    "Morrison",
                    "Murphy",
                    "Murray",
                    "Newman",
                    "O'Neill",
                    "Owen",
                    "Palmer",
                    "Paterson",
                    "Pearce",
                    "Phillips",
                    "Price",
                    "Rees",
                    "Reid",
                    "Richards",
                    "Roberts",
                    "Robertson",
                    "Robinson",
                    "Ross",
                    "Russell",
                    "Scott",
                    "Shaw",
                    "Smith",
                    "Stewart",
                    "Taylor",
                    "Thomas",
                    "Thompson",
                    "Turner",
                    "Walker",
                    "Ward",
                    "Watson",
                    "Webb",
                    "White",
                    "Wilkinson",
                    "Williams",
                    "Wilson",
                    "Wood",
                    "Wright",
                    "Young"
                ]
            }
        };

        // Fisher-Yates Shuffle
        function shuffle(array) {
            var i = 0
                , j = 0
                , temp = null

            for (i = array.length - 1; i > 0; i -= 1) {
                j = Math.floor(Math.random() * (i + 1))
                temp = array[i]
                array[i] = array[j]
                array[j] = temp
            }
        }

        var jumble = [];
        for (var i = 0; i < 11; i++) {
            var jumbler = [0, 1, 2, 3, 4, 5, 6];
            shuffle(jumbler);
            for (var j = 0; j < 7; j++) {
                jumble.push((i * 7) + jumbler[j]);
            }
        }

        function pick(list, i) {
            var offset = jumble[i % 77];

            return list[offset % list.length];
        }

        function titleCase(str) {
            str = str.toLowerCase().split(' ');
            for (var i = 0; i < str.length; i++) {
                str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1);
            }
            return str.join(' ');
        }

        function getDomIndex(target) {
            return [].slice.call(target.parentNode.children).indexOf(target)
        }

        var viewheight = window.innerHeight;
        var viewCentre = window.innerHeight / 2;
        var level;
        var shelf;
        var hand;
        var handEl;
        var selectedIndex = 0;
        var handIndex = 0;
        var camerapos = 0.0;
        var handheight = 0;
        var cameraVelocity = 0.0;
        var frictionRatio = 0.4;

        var reserve = [];
        var books = [];
        var hues = [120, 143, 166, 206, 270, 300, 324, 348, 30, 90];
        var widths = [300, 314, 322, 330, 339, 351, 362, 373, 381, 389, 400];
        var heights = [46, 52, 56, 61, 69, 74, 81];

        function drawBook(book) {
            var authorEl = document.createElement("div");
            authorEl.classList.add("author");
            authorEl.appendChild(document.createTextNode(book.author));
            var titleEl = document.createElement("div");
            titleEl.classList.add("title");
            titleEl.appendChild(document.createTextNode(book.title));
            var bookEl = document.createElement("div");
            bookEl.classList.add("book");
            bookEl.style.width = "" + book.width + "px";
            bookEl.style.height = "" + book.height + "px";

            switch (book.layout) {
                case 0: bookEl.style.justifyContent = "space-between"; break;
                case 1: bookEl.style.justifyContent = "flex-start"; break;
                case 2: bookEl.style.justifyContent = "flex-end"; break;
                case 3: bookEl.style.justifyContent = "center"; break;
            }

            console.log(book.hue);

            var brightness = book.brightness;
            bookEl.style.color = brightness ? chroma.oklch(0.9, 0.01, book.hue).css() : chroma.oklch(0.05, 0.01, book.hue).css();
            if (brightness) { titleEl.style.fontVariantCaps = "small-caps"; } else { titleEl.style.fontWeight = 600; }
            bookEl.style.background = "linear-gradient(180deg, " +
                chroma.oklch(brightness ? 0.3 : 0.7, 0.10, book.hue).css() + " 0%, " +
                chroma.oklch(brightness ? 0.6 : 0.95, 0.15, book.hue).css() + " 5%, " +
                chroma.oklch(brightness ? 0.5 : 0.85, 0.15, book.hue).css() + " 15%, " +
                chroma.oklch(brightness ? 0.35 : 0.7, 0.15, book.hue).css() + " 85%, " +
                chroma.oklch(brightness ? 0.2 : 0.5, 0.10, book.hue).css() + " 100%)";

            switch (book.style)
            {
                case 2:
                    if (brightness)
                    {
                        bookEl.style.background = "linear-gradient(180deg, " +
                        chroma.oklch(brightness ? 0.3 : 0.75, 0.01, book.hue).css() + " 0%, " +
                        chroma.oklch(brightness ? 0.5 : 0.95, 0.01, book.hue).css() + " 5%, " +
                        chroma.oklch(brightness ? 0.3 : 0.75, 0.025, book.hue).css() + " 15%, " +
                        chroma.oklch(brightness ? 0.20 : 0.68, 0.025, book.hue).css() + " 90%, " +
                        chroma.oklch(brightness ? 0.05 : 0.5, 0.03, book.hue).css() + " 100%)";  

                        titleEl.style.color = chroma.oklch(0.80, 0.2, book.hue).css();
                        authorEl.style.color = chroma.oklch(0.96, 0.01, book.hue).css();
                    }
                    else
                    {
                        bookEl.style.background = "linear-gradient(180deg, " +
                        chroma.oklch(brightness ? 0.3 : 0.82, 0.02, book.hue).css() + " 0%, " +
                        chroma.oklch(brightness ? 0.5 : 0.99, 0.02, book.hue).css() + " 5%, " +
                        chroma.oklch(brightness ? 0.3 : 0.92, 0.04, book.hue).css() + " 15%, " +
                        chroma.oklch(brightness ? 0.20 : 0.85, 0.04, book.hue).css() + " 90%, " +
                        chroma.oklch(brightness ? 0.05 : 0.65, 0.02, book.hue).css() + " 100%)";

                        titleEl.style.color = chroma.oklch(0.3, 0.25, book.hue).css();
                        authorEl.style.color = chroma.oklch(0.2, 0.01, book.hue).css();
                    }
                break;
                case 1:
                    if (brightness)
                    {
                        titleEl.style.background = "linear-gradient(180deg, " +
                        chroma.oklch(brightness ? 0.3 : 0.75, 0.01, book.hue).css() + " 0%, " +
                        chroma.oklch(brightness ? 0.5 : 0.95, 0.01, book.hue).css() + " 5%, " +
                        chroma.oklch(brightness ? 0.3 : 0.75, 0.03, book.hue).css() + " 15%, " +
                        chroma.oklch(brightness ? 0.20 : 0.68, 0.03, book.hue).css() + " 90%, " +
                        chroma.oklch(brightness ? 0.05 : 0.5, 0.03, book.hue).css() + " 100%)";                
                    }
                    else
                    {
                        authorEl.style.background = "linear-gradient(180deg, " +
                        chroma.oklch(brightness ? 0.3 : 0.82, 0.01, book.hue).css() + " 0%, " +
                        chroma.oklch(brightness ? 0.5 : 0.99, 0.01, book.hue).css() + " 5%, " +
                        chroma.oklch(brightness ? 0.3 : 0.92, 0.02, book.hue).css() + " 15%, " +
                        chroma.oklch(brightness ? 0.20 : 0.85, 0.02, book.hue).css() + " 90%, " +
                        chroma.oklch(brightness ? 0.05 : 0.7, 0.02, book.hue).css() + " 100%)";  
                    }
                    break;
                case 0:
                    if (brightness)
                    {
                        bookEl.style.color = chroma.oklch(0.82, 0.08, 90).css();
                        authorEl.style.color = chroma.oklch(0.92, 0.02, book.hue).css();
                        titleEl.style.fontWeight = "600";
                    }
                    else
                    {
                        bookEl.style.background = "linear-gradient(180deg, " +
                            chroma.oklch(brightness ? 0.3 : 0.6, 0.10, book.hue).css() + " 0%, " +
                            chroma.oklch(brightness ? 0.6 : 0.825, 0.15, book.hue).css() + " 5%, " +
                            chroma.oklch(brightness ? 0.5 : 0.75, 0.15, book.hue).css() + " 15%, " +
                            chroma.oklch(brightness ? 0.35 : 0.60, 0.15, book.hue).css() + " 90%, " +
                            chroma.oklch(brightness ? 0.2 : 0.5, 0.10, book.hue).css() + " 100%)";
                        titleEl.style.color = chroma.oklch(0.92, 0.01, book.hue).css();
                    }
                    break;
            }

            if (book.order == 0) {
                bookEl.appendChild(authorEl);
                bookEl.appendChild(titleEl);
            }
            else {
                bookEl.appendChild(titleEl);
                bookEl.appendChild(authorEl);
            }
            return bookEl;
        }

        function createBooks() {
            for (var i = 0; i < 200; i++) {
                var given = (i % 2 == 0) ? pick(names["given-names"].negative, i / 2) : pick(names["given-names"].standard, Math.floor(i / 2));
                var family = (i % 2 == 0) ? pick(names["family-names"].frequent, i / 2) : pick(names["family-names"].negative, Math.floor(i / 2));

                var thisBook = {
                    "author": given + " " + family,
                    title: pick(titles, i),
                    "hue": pick(hues, i),
                    "brightness": Math.floor(Math.random() * 2),
                    "style": Math.floor(Math.random() * 3),
                    "order": Math.floor(Math.random() * 2),
                    "layout": Math.floor(Math.random() * 4),
                    width: pick(widths, i),
                    height: pick(heights, i)
                };
                reserve.push(
                    thisBook
                );
            }
        }

        function drawBooks() {
            handEl.innerHTML = "";
            shelf.innerHTML = "";

            for (var thisBook of books) {
                var bookEl = drawBook(thisBook);
                shelf.appendChild(bookEl);
            }
        }

        var buttonTimeout = 100;
        var buttonLastPressed = {};


        function draw() {

            if (gp) {
                //console.log(gp.buttons)
                for (var button in navigator.getGamepads()[0].buttons) {
                    if (button.pressed) {
                        console.log("BUTTON");
                    }
                }

                // check the buttons to see if we're meant to be doing anything
                if (navigator.getGamepads()[0].buttons[12].pressed && (!buttonLastPressed[12] || buttonLastPressed[12] < (performance.now() - buttonTimeout))) {
                    buttonLastPressed[12] = performance.now();
                    down();
                }
                if (navigator.getGamepads()[0].buttons[13].pressed && (!buttonLastPressed[13] || buttonLastPressed[13] < (performance.now() - buttonTimeout))) {
                    buttonLastPressed[13] = performance.now();
                    up();
                }
                if (navigator.getGamepads()[0].buttons[0].pressed && (!buttonLastPressed[0] || buttonLastPressed[0] < (performance.now() - buttonTimeout))) {
                    buttonLastPressed[0] = performance.now();
                    grab();
                }
            }

            viewheight = window.innerHeight;
            viewCentre = viewheight / 2;

            var bookCentre = books.slice(0, selectedIndex).reduce((prev, book) => prev + book.height, 0);

            if (hand) {
                // Center the gap where the book would get inserted
                if (selectedIndex == handIndex) {
                    // The book appears in the centre of the placeholder gap
                    bookCentre = bookCentre + (books[selectedIndex].height / 2);
                }
                else if (selectedIndex > handIndex) {
                    // Insert the book *after* the selected book
                    bookCentre = bookCentre + books[selectedIndex].height;
                }
                else {
                    // Insert the book *before* the selected book
                    // We need do nothing
                }
            }
            else {
                // Centre the selected book
                bookCentre = bookCentre + (books[selectedIndex].height / 2);
            }

            // try and seek towards the right position
            var target = viewCentre - bookCentre;

            cameraVelocity = ((target - camerapos) * 0.4);

            camerapos = camerapos + cameraVelocity;
            level.style.transform = "translate(0, " + camerapos + "px)";

            if (hand) { handheight = handheight + ((200 - handheight) * 0.3); } else { handheight = 0; }
            var handScale = 1 + ((handheight / 150) * 0.2);
            handEl.style.transform = "translate(" + handheight + "px, " + (viewCentre - 50) + "px) scale(" + handScale + ")";
        }

        function highlightSelected() {
            var selected = document.querySelector(".selected");
            if (selected) { selected.classList.remove("selected"); }

            if (!hand) {
                var bookEls = document.querySelectorAll("#shelf .book");
                bookEls[selectedIndex].classList.add("selected");
            }
        }

        var gp = null;

        function up() {
            if (selectedIndex < books.length - 1) {
                selectedIndex++;
                highlightSelected();
            }
        }

        function down() {
            if (selectedIndex > 0) {
                selectedIndex--;
                highlightSelected();
            }
        }

        function grab() {
            console.log("fnord");
            if (hand) {
                // put the book down
                books.splice(handIndex, 1);
                books.splice(selectedIndex, 0, hand);
                hand = null;

                drawBooks();
                draw();
                highlightSelected();

                // Check if it is sorted!
                for (var achievement of achievements) {
                    if (achievement.check()) {
                        console.log("sorted!");
                        console.log("Got " + achievement.title);

                        var congratsEl = document.getElementById("alert");
                        congratsEl.style.visibility = "visible";
                        congratsEl.innerText = achievement.title + ": " + achievement.reward;
                        achievement.finished();
                        drawBooks();
                        draw();
                        highlightSelected();
                        setTimeout(() => {
                            document.getElementById("alert").style.visibility = "hidden";
                        }, 5000);
                    }
                }
            }
            else {
                hand = books[selectedIndex];
                handIndex = selectedIndex;
                var bookEls = document.querySelectorAll("#shelf .book");
                bookEls[selectedIndex].classList.add("placeholder");

                handEl.appendChild(drawBook(hand));
                highlightSelected();
            }
        }

        function start() {

            // set up controller support
            window.addEventListener("gamepadconnected", function (e) {
                gp = navigator.getGamepads()[e.gamepad.index];
                console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                    gp.index, gp.id,
                    gp.buttons.length, gp.axes.length);
            });

            shuffle(widths);
            shuffle(heights);
            shuffle(hues);
            shuffle(titles);

            shuffle(names["given-names"].negative);
            names["given-names"].negative = names["given-names"].negative.map((el) => titleCase(el));
            shuffle(names["given-names"].standard);
            names["given-names"].standard = names["given-names"].standard.map((el) => titleCase(el));
            shuffle(names["family-names"].negative);
            names["family-names"].negative = names["family-names"].negative.map((el) => titleCase(el));
            shuffle(names["family-names"].frequent);
            names["family-names"].frequent = names["family-names"].frequent.map((el) => titleCase(el));

            level = document.getElementById("level");
            shelf = document.getElementById("shelf");
            handEl = document.querySelector("#hand");
            viewheight = window.innerHeight;

            selectedIndex = 0;

            createBooks();
            books = reserve.splice(0, 14);
            drawBooks();
            draw();
            highlightSelected();

            window.addEventListener('keydown', function (e) {
                switch (e.keyCode) {
                    case 40:
                        up();
                        break;
                    case 38:
                        down();
                        break;
                    case 37:
                    case 39:
                    case 13:
                        grab();
                        break;
                    default:
                        console.log(e.keyCode);
                        break;
                }
            });

            window.addEventListener('mousemove', function (e) {
                if (hand) {
                    // if user starts dragging, how do we handle that?
                }
            });

            window.addEventListener('mousedown', function (e) {
                var location = e.clientY;

                if ((e.target.parentElement && e.target.parentElement.id == "hand") || (e.target.parentElement && e.target.parentElement.parentElement && e.target.parentElement.parentElement.id == "hand")) {
                    console.log("clicked on book in hand");
                    grab();
                } else if (e.target.classList.contains("book") || (e.target.parentElement && e.target.parentElement.classList.contains("book"))) {

                    var index = 0;
                    if (e.target.classList.contains("book")) {
                        console.log(e.target);
                        console.log(getDomIndex(e.target));
                        index = getDomIndex(e.target);
                    }
                    else if (e.target.parentElement.classList.contains("book")) {
                        console.log(e.target.parentElement);
                        console.log(getDomIndex(e.target.parentElement));
                        index = getDomIndex(e.target.parentElement);
                    }
                    if (selectedIndex != index) {
                        console.log("moving to " + index);
                        selectedIndex = index;
                        if (!hand) {
                            grab();
                        }
                        else {
                            draw();
                            highlightSelected();
                        }
                    }
                    else {
                        console.log("clicked selected item");
                        grab();
                    }
                }
                else {
                    if (location < viewCentre - 50) {
                        down();
                    }
                    else if (location > viewCentre + 50) {
                        up();
                    }
                    else {
                        grab();
                    }
                }

                e.preventDefault();
                e.stopPropagation();
            });

            // window.addEventListener('touchstart', function (e) {
            //     console.log(e);
            //     if (e.changedTouches.length > 0)
            //     {
            //         var location = e.changedTouches[0].clientY;
            //         if (location < viewCentre - 50)
            //         {
            //             down();
            //         }
            //         else if (location > viewCentre + 50)
            //         {
            //             up();
            //         }
            //         else
            //         {
            //             grab();
            //         }
            //         e.preventDefault();
            //         e.stopPropagation();
            //     }
            // })

            window.setInterval(() => { draw(); }, 20);
        }
    </script>
</head>

<body onload="start()">
    <div id="alert">
        <p>Sorted by author: +5 books</p>
    </div>
    <div id="hand">

    </div>
    <div id="level">
        <div id="shelf">

        </div>
    </div>
</body>

</html>